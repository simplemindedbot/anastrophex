# Failure Pattern: Hidden Flag on site-packages Directory

**Observed:** Oct 23, 2025 - anastrophex repository setup
**Python Version:** 3.12.11 (mise installation)

## Behavior

1. Create venv with `python -m venv .venv`
2. Install package with `pip install -e ".[dev]"`
3. Package installs successfully, .pth file created
4. Import fails: `ModuleNotFoundError`
5. .pth file exists with correct content
6. Manually testing splitlines() works correctly
7. Adding trailing newline doesn't help

## Root Cause

The `site-packages` directory had the macOS `UF_HIDDEN` filesystem flag set, causing Python 3.12's `site.py` to skip processing **all** `.pth` files within it.

**Python 3.12 behavior change:**
In Python 3.12, `site.py` added a check to skip .pth files that have the hidden filesystem attribute (either macOS `UF_HIDDEN` flag or Windows `FILE_ATTRIBUTE_HIDDEN`):

```python
# From Python 3.12 site.py, line ~175
st = os.lstat(fullname)
if ((getattr(st, 'st_flags', 0) & stat.UF_HIDDEN) or
    (getattr(st, 'st_file_attributes', 0) & stat.FILE_ATTRIBUTE_HIDDEN)):
    _trace(f"Skipping hidden .pth file: {fullname!r}")
    return
```

When the parent directory has the hidden flag, files within it inherit this attribute on macOS.

## Diagnostic Command

```bash
# Check if site-packages has hidden flag
ls -ldO .venv/lib/python3.*/site-packages/

# Should show "-" not "hidden" in the flags column
# Example output with problem:
# drwxr-xr-x@ - sc hidden Oct 23 17:23 .venv/lib/python3.12/site-packages

# Check specific .pth file
stat -f "%Sf" .venv/lib/python3.*/site-packages/*.pth

# Run Python in verbose mode to see what's happening
.venv/bin/python -v -c "import sys" 2>&1 | grep -i "pth"
```

## Solution

```bash
# Clear hidden flag from site-packages and all contents
chflags -R nohidden .venv/lib/python3.*/site-packages/

# Verify it's cleared
ls -ldO .venv/lib/python3.*/site-packages/
# Should show "-" instead of "hidden"

# Test import
.venv/bin/python -c "import your_package"
```

## Why This Happened

**Unknown - requires investigation:**
- Did `python -m venv` set this flag?
- Did mise's Python installation have this flag set?
- Was it inherited from a parent directory?
- Is this specific to mise's Python builds?

To investigate:
```bash
# Check if mise's Python installation has hidden flag
ls -ldO $(mise where python)/lib/python3.12/

# Check parent directories
ls -ldO .venv/
ls -ldO .venv/lib/
ls -ldO .venv/lib/python3.12/
```

## Detection Pattern for Anastrophex

```python
pattern_signature = "hidden-site-packages"

def detect(tool_history):
    # Sequence:
    # 1. pip install -e succeeded
    # 2. Import fails with ModuleNotFoundError
    # 3. .pth file exists with correct content
    # 4. Multiple attempts to fix (newlines, format, etc.) all fail

    if has_sequence(tool_history, [
        "pip install -e . succeeded",
        "import failed",
        ".pth file exists and looks correct",
        "tried fixing format/newlines",
        "still fails"
    ]):
        # Suggest verbose mode diagnostic
        return True
    return False

def intervention():
    return """
ðŸ” Everything looks correct but import still fails?

When .pth file format is correct but not being processed,
check filesystem attributes:

Diagnostic:
python -v -c "import sys" 2>&1 | grep -i "skipping.*pth"

If you see "Skipping hidden .pth file":
ls -ldO .venv/lib/python*/site-packages/

Fix:
chflags -R nohidden .venv/lib/python*/site-packages/
"""
```

## Trigger Conditions

```
IF editable install completes without error
   AND .pth file exists in site-packages
   AND .pth file content is correct (splitlines() works)
   AND import fails with ModuleNotFoundError
   AND python -v shows "Skipping hidden .pth file"
THEN: Hidden filesystem attribute is set
```

## Lessons for Debugging

1. **Use verbose mode earlier**: `python -v` would have shown "Skipping hidden .pth file" immediately
2. **Don't assume file format**: Even when content looks correct, check filesystem attributes
3. **Python 3.12 breaking change**: The hidden attribute check is new in 3.12
4. **Check parent directory flags**: Flags on parent directories can affect children

## Related Python Changes

- Python 3.12 added the hidden file check to prevent processing .pth files that users explicitly marked as hidden
- This is a security/safety feature but can cause confusion when flags are set unintentionally
- Prior to 3.12, only files starting with `.` (dot) were skipped

## Prevention

When creating venvs, verify site-packages doesn't have hidden flag:

```bash
# After creating venv
python -m venv .venv

# Check immediately
ls -ldO .venv/lib/python*/site-packages/
stat -f "%Sf" .venv/lib/python*/site-packages/

# If hidden, clear before installing packages
if [[ "$(stat -f "%Sf" .venv/lib/python*/site-packages/)" == "hidden" ]]; then
    chflags -R nohidden .venv/lib/python*/site-packages/
fi
```

## Open Questions

1. Why did site-packages get the hidden flag in the first place?
2. Is this specific to mise's Python installation method?
3. Does this happen on all macOS systems or only certain configurations?
4. Should this be reported to mise or Python as a bug?

## Meta-Learning

This failure pattern demonstrates:
- **Assumption trap**: Assumed file content was the issue when it was filesystem metadata
- **Tool selection**: Should have used `python -v` much earlier
- **Diagnostic hierarchy**: Check increasingly obscure causes only after ruling out common ones
- **Python version awareness**: Breaking changes in 3.12 that weren't in earlier versions
